# Домашняя работа 0 недели

## Задание

- Примите абсурдность требований. Главная цель этой учебной системы — помочь изучить темы из курса в безопасной среде.  
- Опишите, как будете исправлять ситуацию с системой и решать проблемы, описанные бизнесом. Для этого опишите коммуникации списком: какие они и как поменяются. Можете использовать идентификатор **[COMM-ХХХ]**. Не заморачивайтесь сильно с проработкой, не бойтесь ошибиться — мы это делаем, чтобы вы в конце обучения сравнили «было» и «стало».  

## Решение

### 1. Зависимость на уровне данных, и синхронных вызовах команд (проблемы [Problem-080], [Problem-070], [Problem-030])

Исходя из списка коммуникаций, мы видим что:

1. Сервисы Найма и Бонусов зависят от информации о Менеджерах, которой владеет сервис Менеджмента заданий. Оба этих сервиса получают информацию о Менеджерах синхронно по HTTP.
2. Сервис Найма так же получает информацию о Заданиях, синхронно по HTTP от сервиса Менеджмента заданий.
3. Бизнес-команды по начислению или списанию бонусов при выполнении заданий также вызываются синхронно по HTTP.

Я думаю, что именно это и является причиной проблемы **[Problem-080]**, когда упавший сервис Менеджмента заданий или Бонусов не позволяет кандидатам выполнять задания.  

Я предполагаю, что эту проблему можно решить путем изменения вида коммуникации с синхронного HTTP вызова на асинхронный event stream.

1. Чтобы сервис Найма позволял кандидатам выполнять задания независимо от сервисов Менеджмента заданий и Бонусов, сервис Найма должен в себе хранить информацию о Менеджерах и Заданиях (необходимую для выполнения заданий). Для этих целей коммуникации **[COMM-010]**, **[COMM-020]**, **[COMM-070]** можно поменять на асинхронные, Event-Carried State Transfer через Кафку. Например, стримить данные о Менеджерах (допустим, всех) и данные о Заданиях (возможно, только назначенные задания, а не вообще все).

2. Коммуникации **[COMM-040]**, **[COMM-050]**, **[COMM-080]** можно также поменять на отправку бизнес-событий в Кафку ("Задание выполнено успешно", "Задание провалено", "Менеджер создал новое задание в системе"):

    - Это нужно для независимого выполнения заданий кандидатами в сервисе Найма **[Problem-080]**;
    - Это также должно помочь с проблемами **[Problem-030]**, **[Problem-070]**:
        Я предполагаю, что Рейтинг задания должен быть частью Бизнес-события _"Задание выполнено успешно"_. В таком случае, даже если сервис Бонусов был недоступен, когда он поднимется то сможет корректно применить Бонус, а коммуникация **[COMM-060]** вообще будет не нужна. Однако, если окажется что это противоречит требованиям (рейтинг должен быть максимально актуальным **на момент начисления** Бонуса, а не **на момент отправки события в очередь**) - в таком случае коммуникация **[COMM-060]** должна остаться, но должна стать **синхронной**, клиент - сервис Бонусов, сервер - сервис Найма. Я бы пошел это обсуждать с Бизнесом.

Проблему двойного начисления бонусов в случае коммуникации через очередь должна решаться через дедупликацию евентов.

### 2. Нагрузка на систему (проблемы [Problem-060], [Problem-050], [Problem-040])

Проблемы **[Problem-060]**, **[Problem-050]**, **[Problem-040]** как будто бы указывают, что сервис Менеджмента заданий - в данный момент подвергается высокой нагрузке.  

Мы также знаем, что:

- Кандидатов в учителя много, поэтому операция "Назначить задания всем кандидатам" - тяжелая (много данных нужно запросить из внешнего сервиса).
- При создании заданий необходимо вызвать сторонний HTTP API, куда мы продаём созданные задания. Возможно, он тоже долго отвечает и это влияет на работоспособность системы у нас.

Возможно, если коммуникации **[COMM-010]**, **[COMM-020]**, **[COMM-070]** будут асинхронными (см. выше), то число запросов к сервису Менеджмента сильно снизится, как следствие и снизится нагрузка.

### 3. Проблема долгой проверки выполнения задания [Problem-010]

Я предполагаю, что сейчас бизнес-процесс по проверке выполнения задания кандидатом выглядит так:

1) Кандидат отправляет свой ответ в форму в UI, в сервис Найма
2) Сервис Найма синхронным HTTP вызовом получает информацию о Задании из сервиса Менеджмента заданий
3) Когда данные получены, необходимо сравнить ответ кандитата с правильным ответом, который (предположительно) лежит в самом задании.
4) Получив результат (правильно/неправильно), сервис Найма может посчитать новое значение рейтинга задания и отправить его в Кафку в нужный топик.
5) Если результат был правильный, синхронно вызывается сервис Бонусов по **[COMM-040]**, иначе - по **[COMM-050]**

Вероятно, шаги 3 и 4 не должны занимать много времени (либо мы чего-то не знаем). Поэтому задержки скорее всего вызваны синхронными вызовами нагруженного сервиса. Возможно, убрав эти синхронные вызовы (как указано выше) таких задержек при проверке заданий уже не будет.

### 4. Проблема кандидатов-читеров [Problem-020]

Исходя из описаний требований и проблемы, я пока не понимаю как кандидаты могут делиться лёгкими заданиями, если назначает задания на кандидатов Менеджер.

Я думаю, что "окно возможностей" для читинга всё равно останется - потому что усложнение заданий не происходит мгновенно, сначала мы должны назначить Менеджера, а затем он еще будет редактировать задание. Это окно можно сократить (или убрать совсем) если обсудить с Бизнесом, должны ли мы перестать принимать ответы от кандидатов, которым назначено "лёгкое" задание (например, сбросить назначение, либо просто заблокировать прием ответа).

Если информация о Заданиях будет стримиться в сервис Найма, то при редактировании Задания должна появляться новая версия Задания, и создаваться бизнес-событие _"Новая версия Задания Х опубликована"_, на которое должен подписаться сервис Найма и обновить информацию у себя. Не уверен, что синхронная коммуникация здесь поможет, т.к. нам необходимо отправить новый State доменного объекта, который мы ранее отправляли через очередь.
